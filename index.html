<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Senate Forecast</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a; color: #eee;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 320px;
            min-height: 100vh;
        }

        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 20px;
            padding: 4px;
            background: #1a1a2e;
            border-radius: 8px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-btn {
            padding: 10px 24px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: #ccc; background: #252540; }
        .tab-btn.active {
            background: #3b82f6;
            color: #fff;
        }
        .tab-btn.active.senate { background: #6366f1; }
        .tab-btn.active.house { background: #8b5cf6; }
        .tab-btn.active.congress { background: #10b981; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Control Bar */
        .control-bar {
            display: flex; justify-content: center; gap: 40px;
            margin-bottom: 20px; padding: 15px;
            background: #1a1a2e; border-radius: 10px;
        }
        .control-stat { text-align: center; }
        .control-stat .label { font-size: 12px; color: #666; text-transform: uppercase; }
        .control-stat .value { font-size: 32px; font-weight: bold; }
        .control-stat.dem .value { color: #3b82f6; }
        .control-stat.rep .value { color: #ef4444; }

        /* Hex Map */
        .hex-map {
            display: flex; justify-content: center;
            margin-bottom: 20px;
        }
        .hex-grid {
            display: grid;
            grid-template-columns: repeat(12, 44px);
            gap: 2px;
        }
        .hex-cell {
            width: 44px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 2px solid transparent;
            position: relative;
        }
        .hex-cell:hover { transform: scale(1.1); z-index: 10; }
        .hex-cell.selected { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .hex-cell.locked { border-color: #fbbf24; }
        .hex-cell.empty { visibility: hidden; }
        .hex-cell .prob {
            position: absolute; bottom: 2px; right: 3px;
            font-size: 8px; opacity: 0.8;
        }

        /* Snake Chart */
        .snake-section { margin-top: 20px; }
        .snake-section h2 { font-size: 16px; margin-bottom: 10px; color: #888; }
        .snake-chart {
            display: flex; flex-wrap: wrap; gap: 4px;
            padding: 10px;
            background: #1a1a2e; border-radius: 8px;
        }
        .snake-item {
            width: 50px; height: 36px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .snake-item:hover { transform: scale(1.1); z-index: 10; }
        .snake-item.selected { border-color: #fff; }
        .snake-item.locked { border-color: #fbbf24; }
        .snake-item .state { font-weight: bold; }
        .snake-item .pct { font-size: 9px; opacity: 0.8; }

        /* Sidebar */
        .sidebar {
            background: #1a1a2e;
            border-left: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar h2 { font-size: 14px; color: #888; margin-bottom: 15px; text-transform: uppercase; }

        .selected-race {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .selected-race .state-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .selected-race .race-type { color: #666; font-size: 12px; margin-bottom: 10px; }
        .selected-race .prob-display {
            display: flex; gap: 20px; margin: 15px 0;
        }
        .selected-race .prob-item { text-align: center; }
        .selected-race .prob-item .party { font-size: 12px; color: #888; }
        .selected-race .prob-item .pct { font-size: 24px; font-weight: bold; }
        .selected-race .prob-item.dem .pct { color: #3b82f6; }
        .selected-race .prob-item.rep .pct { color: #ef4444; }

        .selected-race .actions { margin-top: 15px; }
        .selected-race .actions button {
            padding: 8px 16px; margin-right: 8px;
            border: none; border-radius: 4px;
            cursor: pointer; font-size: 12px;
        }
        .selected-race .actions .lock-d { background: #3b82f6; color: #fff; }
        .selected-race .actions .lock-r { background: #ef4444; color: #fff; }
        .selected-race .actions .unlock { background: #374151; color: #fff; }

        .locked-summary {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .locked-summary .locked-item {
            display: flex; justify-content: space-between;
            padding: 5px 0; border-bottom: 1px solid #333;
            font-size: 13px;
        }
        .locked-summary .locked-item:last-child { border-bottom: none; }
        .locked-summary .locked-item .outcome { font-weight: bold; }
        .locked-summary .locked-item .outcome.D { color: #3b82f6; }
        .locked-summary .locked-item .outcome.R { color: #ef4444; }
        .locked-summary .locked-item .outcome.I_Osborn { color: #fbbf24; }
        .locked-summary .locked-item .outcome.I_Other { color: #d97706; }

        .correlations {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
        }
        .correlations h3 { font-size: 12px; color: #888; margin-bottom: 10px; }
        .corr-item {
            display: flex; justify-content: space-between;
            padding: 4px 0; font-size: 12px;
        }
        .corr-item .val { font-weight: bold; }
        .corr-item .val.pos { color: #22c55e; }
        .corr-item .val.neg { color: #ef4444; }

        .reset-all {
            width: 100%; padding: 10px;
            background: #374151; color: #fff;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 20px;
        }
        .reset-all:hover { background: #4b5563; }

        .sample-count {
            text-align: center; color: #555; font-size: 11px;
            margin-top: 15px;
        }

        /* Methodology section */
        .methodology {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .methodology summary {
            cursor: pointer;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .methodology summary:hover { color: #aaa; }
        .methodology dl { margin: 0; }
        .methodology dt {
            font-weight: bold;
            color: #bbb;
            margin-top: 10px;
            font-size: 12px;
        }
        .methodology dd {
            color: #888;
            font-size: 11px;
            margin-left: 0;
            margin-top: 2px;
            line-height: 1.4;
        }
        .methodology p {
            color: #888;
            font-size: 11px;
            margin: 10px 0;
            line-height: 1.4;
        }

        /* Histogram */
        .histogram-section { margin-top: 20px; }
        .histogram-section h2 { font-size: 16px; margin-bottom: 10px; color: #888; }
        .histogram-container {
            padding: 15px;
            background: #1a1a2e; border-radius: 8px;
        }
        .histogram {
            display: flex;
            align-items: flex-end;
            height: 120px;
            gap: 2px;
        }
        .hist-bar {
            flex: 1;
            min-width: 8px;
            background: #4a4a6a;
            border-radius: 2px 2px 0 0;
            position: relative;
            cursor: pointer;
            transition: opacity 0.1s;
        }
        .hist-bar:hover { opacity: 0.8; }
        .hist-bar.dem { background: linear-gradient(#3b82f6, #1d4ed8); }
        .hist-bar.rep { background: linear-gradient(#ef4444, #b91c1c); }
        .hist-bar.locked {
            box-shadow: 0 0 8px #fbbf24, inset 0 0 0 2px #fbbf24;
        }
        .hist-bar.majority-line {
            position: absolute;
            border-left: 2px dashed #fbbf24;
            height: 100%;
            pointer-events: none;
        }
        .histogram-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            padding: 0 2px;
        }
        .histogram-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 11px;
            color: #888;
        }
        .histogram-legend span { display: flex; align-items: center; gap: 5px; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; }
        .legend-box.dem { background: #3b82f6; }
        .legend-box.rep { background: #ef4444; }

        /* Markets Panel */
        .markets-panel {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .market-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .market-item:last-child { border-bottom: none; }
        .market-item a {
            color: #60a5fa;
            text-decoration: none;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        .market-item a:hover { text-decoration: underline; }
        .market-meta {
            font-size: 10px;
            color: #666;
        }
        .market-meta .vol { color: #22c55e; }
        .market-meta .bettors { color: #a78bfa; }
        .market-item.relevant { background: #1e3a5f; margin: 0 -15px; padding: 8px 15px; }
        .price-compare {
            font-size: 11px;
            color: #9ca3af;
            margin: 4px 0;
            font-family: monospace;
        }
        .price-compare.warning { color: #fbbf24; }
        .price-compare .diff {
            color: #6b7280;
            font-size: 10px;
        }
        .price-compare.warning .diff { color: #f59e0b; }

        /* Top Maps Panel */
        .top-maps {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .top-maps h3 { font-size: 12px; color: #888; margin-bottom: 10px; }
        .map-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .map-item:hover { background: #1a1a2e; }
        .map-item.selected { background: #2d2d50; border: 1px solid #4a4a8a; }
        .map-item .rank {
            width: 20px;
            font-size: 10px;
            color: #666;
            flex-shrink: 0;
        }
        .map-item .bar-container {
            flex: 1;
            height: 16px;
            background: #1a1a2e;
            border-radius: 3px;
            margin: 0 8px;
            overflow: hidden;
        }
        .map-item .bar {
            height: 100%;
            border-radius: 3px;
            display: flex;
            align-items: center;
            padding-left: 4px;
            font-size: 9px;
            color: rgba(255,255,255,0.9);
        }
        .map-item .bar.r-control { background: linear-gradient(90deg, #ef4444, #b91c1c); }
        .map-item .bar.d-control { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .map-item .bar.split-control { background: linear-gradient(90deg, #8b5cf6, #6d28d9); }
        .map-item .seats {
            width: 45px;
            font-size: 10px;
            text-align: right;
            color: #888;
            flex-shrink: 0;
        }
        .map-detail {
            background: #1a1a2e;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 11px;
        }
        .map-detail .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        .map-detail .stat-row .label { color: #888; }
        .map-detail .stat-row .value { font-weight: bold; }
        .map-detail .upsets {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #333;
        }
        .map-detail .upset-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 3px;
            font-size: 10px;
            background: #374151;
        }
        .clear-map-btn {
            width: 100%;
            padding: 6px;
            margin-top: 10px;
            background: #374151;
            color: #888;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .clear-map-btn:hover { background: #4b5563; color: #fff; }

        /* Sample Statistics Panel */
        .sample-stats {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .sample-stats h3 { font-size: 12px; color: #888; margin-bottom: 10px; }
        .stat-row {
            display: flex; justify-content: space-between;
            padding: 3px 0; font-size: 12px;
        }
        .stat-row .label { color: #888; }
        .stat-row .value { font-weight: bold; }
        .stat-row .value.warning { color: #fbbf24; }
        .stat-row .value.error { color: #ef4444; }

        .ci-display {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #333;
        }
        .ci-display .label { font-size: 11px; color: #666; margin-bottom: 5px; }
        .ci-bar {
            height: 20px; background: #1a1a2e; border-radius: 4px;
            position: relative; overflow: hidden;
        }
        .ci-bar .range {
            position: absolute; height: 100%;
            background: linear-gradient(90deg, #3b82f6, #a78bfa, #ef4444);
            opacity: 0.6;
        }
        .ci-bar .point {
            position: absolute; height: 100%; width: 3px;
            background: #fff; top: 0;
        }
        .ci-bar .ticks {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: space-between;
            padding: 0 2px; font-size: 8px; color: #666;
            align-items: flex-end;
        }

        /* Context info bar */
        .context-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .context-info .separator {
            margin: 0 10px;
        }

        /* ========== MOBILE RESPONSIVENESS ========== */

        /* Tablet and below: stack layout vertically */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }

            .sidebar {
                border-left: none;
                border-top: 1px solid #333;
                max-height: none;
                order: 2;
            }

            .main-content {
                order: 1;
                overflow-y: visible;
            }

            /* Make hex grid horizontally scrollable */
            .hex-map {
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 10px;
                -webkit-overflow-scrolling: touch;
            }

            .hex-grid {
                min-width: max-content;
            }

            /* Control bar: allow wrapping */
            .control-bar {
                flex-wrap: wrap;
                gap: 20px;
            }

            .control-stat .value {
                font-size: 28px;
            }
        }

        /* Mobile phones */
        @media (max-width: 600px) {
            h1 { font-size: 20px; }
            .subtitle { font-size: 12px; margin-bottom: 15px; }

            .main-content {
                padding: 12px;
            }

            .sidebar {
                padding: 15px;
            }

            /* Compact control bar */
            .control-bar {
                padding: 12px;
                gap: 15px;
                margin-bottom: 15px;
            }

            .control-stat .label { font-size: 10px; }
            .control-stat .value { font-size: 24px; }

            /* Pre-election context: stack on mobile */
            .context-info {
                font-size: 11px;
                line-height: 1.6;
            }
            .context-info .separator {
                display: none;
            }
            .context-info span:not(.separator) {
                display: block;
            }

            /* Smaller hex cells for mobile */
            .hex-grid {
                grid-template-columns: repeat(12, 36px);
                gap: 1px;
            }

            .hex-cell {
                width: 36px;
                height: 32px;
                font-size: 9px;
                border-radius: 3px;
            }

            .hex-cell .prob {
                font-size: 7px;
                bottom: 1px;
                right: 2px;
            }

            /* Snake chart: smaller items */
            .snake-section h2 { font-size: 14px; }

            .snake-chart {
                gap: 3px;
                padding: 8px;
            }

            .snake-item {
                width: 42px;
                height: 32px;
                font-size: 9px;
            }

            .snake-item .pct { font-size: 8px; }

            /* Histogram */
            .histogram-section h2 { font-size: 14px; }
            .histogram { height: 100px; }
            .histogram-labels { font-size: 9px; }
            .histogram-legend { font-size: 10px; gap: 15px; }

            /* Sidebar panels */
            .sidebar h2 { font-size: 12px; margin-bottom: 12px; }

            .sample-stats, .top-maps, .selected-race,
            .locked-summary, .correlations, .markets-panel, .methodology {
                padding: 12px;
                margin-bottom: 15px;
            }

            .stat-row { font-size: 11px; }
            .stat-row .value { font-size: 11px; }

            /* Selected race panel */
            .selected-race .state-name { font-size: 18px; }
            .selected-race .prob-item .pct { font-size: 20px; }
            .selected-race .prob-display { gap: 15px; }

            /* Larger touch targets for buttons */
            .selected-race .actions button {
                padding: 10px 14px;
                font-size: 12px;
                min-height: 40px;
            }

            .reset-all {
                padding: 14px;
                font-size: 14px;
            }

            /* Top maps panel */
            .map-item {
                padding: 8px;
                min-height: 40px;
            }

            .map-item .bar { font-size: 10px; }
            .map-item .seats { font-size: 11px; }

            /* Markets panel */
            .markets-panel { max-height: 250px; }
            .market-item a { font-size: 13px; }
            .market-meta { font-size: 11px; }

            /* CI bar adjustments */
            .ci-display .label { font-size: 10px; }
            .ci-bar .ticks { font-size: 7px; }
        }

        /* Very small phones */
        @media (max-width: 380px) {
            .hex-grid {
                grid-template-columns: repeat(12, 30px);
            }

            .hex-cell {
                width: 30px;
                height: 26px;
                font-size: 8px;
            }

            .hex-cell .prob { display: none; }

            .snake-item {
                width: 36px;
                height: 28px;
                font-size: 8px;
            }

            .control-stat .value { font-size: 20px; }

            .selected-race .prob-display {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1 id="main-title">2026 Congress Forecast</h1>
            <p class="subtitle">Click states to select, double-click to lock outcomes</p>

            <div class="tab-nav">
                <button class="tab-btn senate active" data-tab="senate">Senate</button>
                <button class="tab-btn house" data-tab="house">House</button>
                <button class="tab-btn congress" data-tab="congress">Congress</button>
            </div>

            <!-- Senate Tab -->
            <div id="senate-tab" class="tab-content active">
            <div class="control-bar">
                <div class="control-stat dem">
                    <div class="label">D Control</div>
                    <div class="value" id="d-control">--</div>
                </div>
                <div class="control-stat">
                    <div class="label">Projected</div>
                    <div class="value" id="expected-seats">--</div>
                </div>
                <div class="control-stat rep">
                    <div class="label">R Control</div>
                    <div class="value" id="r-control">--</div>
                </div>
            </div>
            <div class="context-info">
                <span title="Current Senate composition before 2026 elections">Pre-election: 53R-47D</span>
                <span class="separator">•</span>
                <span title="Senators not up for re-election in 2026 (Class 1 & 3)">Not contested: 31R + 34D = 65 seats</span>
                <span class="separator">•</span>
                <span title="Class 2 Senate seats being decided in 2026">35 races contested</span>
            </div>

            <div class="hex-map">
                <div class="hex-grid" id="hex-grid"></div>
            </div>

            <div class="snake-section">
                <h2>Races by Competitiveness (Tipping Point Analysis)</h2>
                <div class="snake-chart" id="snake-chart"></div>
            </div>

            <div class="histogram-section">
                <h2>Seat Count Distribution</h2>
                <div class="histogram-container">
                    <div class="histogram" id="histogram"></div>
                    <div class="histogram-labels">
                        <span>45D</span>
                        <span>50-50</span>
                        <span>55R</span>
                    </div>
                    <div class="histogram-legend">
                        <span><div class="legend-box dem"></div> D majority</span>
                        <span><div class="legend-box rep"></div> R majority</span>
                    </div>
                </div>
            </div>
            </div><!-- End Senate Tab -->

            <!-- House Tab -->
            <div id="house-tab" class="tab-content">
                <div class="control-bar">
                    <div class="control-stat dem">
                        <div class="label">D Control</div>
                        <div class="value" id="house-d-control">--</div>
                    </div>
                    <div class="control-stat">
                        <div class="label">Projected</div>
                        <div class="value" id="house-expected-seats">--</div>
                    </div>
                    <div class="control-stat rep">
                        <div class="label">R Control</div>
                        <div class="value" id="house-r-control">--</div>
                    </div>
                </div>
                <div class="context-info">
                    <span>435 House seats</span>
                    <span class="separator">•</span>
                    <span>218 needed for control</span>
                </div>
                <div class="map-placeholder" style="text-align: center; padding: 40px; background: #1a1a2e; border-radius: 10px; margin-bottom: 20px; color: #666;">
                    District map coming soon
                </div>
                <div class="snake-section">
                    <h2>House Races by Competitiveness</h2>
                    <div class="snake-chart" id="house-snake-chart"></div>
                </div>

                <div class="histogram-section">
                    <h2>House Seat Count Distribution</h2>
                    <div class="histogram-container">
                        <div class="histogram" id="house-histogram"></div>
                        <div class="histogram-labels">
                            <span>200D</span>
                            <span>218 (Control)</span>
                            <span>235R</span>
                        </div>
                        <div class="histogram-legend">
                            <span><div class="legend-box dem"></div> D majority</span>
                            <span><div class="legend-box rep"></div> R majority</span>
                        </div>
                    </div>
                </div>
            </div><!-- End House Tab -->

            <!-- Congress Tab -->
            <div id="congress-tab" class="tab-content">
                <div class="congress-matrix" style="text-align: center; padding: 40px;">
                    <h2 style="margin-bottom: 20px; color: #888;">Congress Control Matrix</h2>
                    <div id="control-matrix" style="display: inline-block;">
                        <table style="border-collapse: collapse; margin: 0 auto;">
                            <tr>
                                <th style="padding: 10px;"></th>
                                <th style="padding: 10px; color: #3b82f6;">D House</th>
                                <th style="padding: 10px; color: #ef4444;">R House</th>
                            </tr>
                            <tr>
                                <th style="padding: 10px; color: #3b82f6;">D Senate</th>
                                <td id="matrix-dd" style="padding: 20px; background: #1a1a2e; border-radius: 8px; margin: 2px;">--%</td>
                                <td id="matrix-dr" style="padding: 20px; background: #1a1a2e; border-radius: 8px; margin: 2px;">--%</td>
                            </tr>
                            <tr>
                                <th style="padding: 10px; color: #ef4444;">R Senate</th>
                                <td id="matrix-rd" style="padding: 20px; background: #1a1a2e; border-radius: 8px; margin: 2px;">--%</td>
                                <td id="matrix-rr" style="padding: 20px; background: #1a1a2e; border-radius: 8px; margin: 2px;">--%</td>
                            </tr>
                        </table>
                    </div>
                    <div style="margin-top: 30px; color: #666;">
                        <p>D Trifecta: <span id="d-trifecta">--%</span> (D Senate + D House + D President)</p>
                        <p>R Trifecta: <span id="r-trifecta">--%</span> (R Senate + R House + R President)</p>
                    </div>
                </div>
            </div><!-- End Congress Tab -->
        </div>

        <div class="sidebar">
            <h2>Sample Statistics</h2>
            <div class="sample-stats" id="sample-stats">
                <div class="stat-row">
                    <span class="label">Total samples</span>
                    <span class="value" id="stat-total">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Filtered samples</span>
                    <span class="value" id="stat-filtered">--</span>
                </div>
                <div class="stat-row">
                    <span class="label" title="Accounts for correlation between samples. ESS = N / τ where τ is the integrated autocorrelation time." style="cursor: help;">Effective sample size</span>
                    <span class="value" id="stat-ess">--</span>
                </div>
                <div class="stat-row">
                    <span class="label" title="95% confidence interval width for D Control probability, using Wilson score interval." style="cursor: help;">Margin of error (95%)</span>
                    <span class="value" id="stat-moe">--</span>
                </div>
                <div class="stat-row">
                    <span class="label" title="Largest difference between model and market prices. Lower is better; >5% may indicate market inconsistency." style="cursor: help;">Max constraint error</span>
                    <span class="value" id="stat-max-error">--</span>
                </div>
                <div class="stat-row">
                    <span class="label" title="Root mean square of all constraint errors. Measures overall fit quality." style="cursor: help;">RMS error</span>
                    <span class="value" id="stat-rms-error">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Data fetched</span>
                    <span class="value" id="stat-data-timestamp" style="font-size: 10px;">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Model run</span>
                    <span class="value" id="stat-model-timestamp" style="font-size: 10px;">--</span>
                </div>
                <div class="ci-display">
                    <div class="label">D Control probability (95% CI)</div>
                    <div class="ci-bar" id="ci-bar">
                        <div class="range" id="ci-range"></div>
                        <div class="point" id="ci-point"></div>
                        <div class="ticks"><span>0%</span><span>50%</span><span>100%</span></div>
                    </div>
                    <div style="text-align: center; font-size: 11px; margin-top: 5px; color: #888;" id="ci-text">--</div>
                </div>
            </div>

            <div id="top-maps-panel">
                <h2>Top Outcome Maps</h2>
                <div class="top-maps" id="top-maps">
                    <div style="color: #666; text-align: center;">Loading...</div>
                </div>
            </div>

            <details class="methodology">
                <summary>Methodology</summary>
                <p>This forecast uses Monte Carlo sampling to generate election scenarios consistent with all market constraints.</p>
                <dl>
                    <dt>Effective Sample Size (ESS)</dt>
                    <dd>Accounts for correlation between samples. Higher ESS means more reliable estimates. ESS = N / τ where τ is the integrated autocorrelation time.</dd>

                    <dt>Margin of Error (MoE)</dt>
                    <dd>95% confidence interval width for the D Control probability, computed using Wilson score interval based on ESS.</dd>

                    <dt>Max Constraint Error</dt>
                    <dd>Largest difference between model probabilities and market prices across all constraints. Lower is better; >5% suggests market prices may be internally inconsistent.</dd>

                    <dt>Correlated Races</dt>
                    <dd>Shows how probabilities shift if a race outcome is known. Example: "+8%" means that race's D probability increases 8 percentage points if the selected race goes D.</dd>
                </dl>
            </details>

            <div id="selected-panel">
                <h2>Selected Race</h2>
                <div class="selected-race" id="selected-race">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        Click a state to see details
                    </div>
                </div>
            </div>

            <div id="locked-panel" style="display: none;">
                <h2>Locked Outcomes</h2>
                <div class="locked-summary" id="locked-summary"></div>
            </div>

            <div id="correlations-panel" style="display: none;">
                <h2>Correlated Races</h2>
                <div class="correlations" id="correlations">
                    <h3 title="Shows how each race's D probability changes if the selected race goes D. Example: +8% means that race is 8 percentage points more likely to go D when the selected race goes D.">If selected goes D, D prob shifts:</h3>
                    <div id="corr-list"></div>
                </div>
            </div>

            <div id="markets-panel">
                <h2>Related Markets</h2>
                <div class="markets-panel" id="markets-list"></div>
            </div>

            <button class="reset-all" id="reset-btn" style="display: none;">Reset All Locks</button>
            <div class="sample-count" id="sample-count"></div>
        </div>
    </div>

    <script>
    let samples = [];
    let races = [];
    let chainIds = [];  // Chain ID for each sample (for per-chain ESS)
    let locks = {};
    let seatLock = null;  // Lock to specific R seat count (e.g., 51 = 51R/49D)
    let selected = null;
    let essEstimate = null;  // ESS estimate (recomputed on filter)
    let markets = [];  // Market metadata
    let maxError = null;  // Max constraint error from sampler (real constraints only)
    let rmsError = null;  // RMS constraint error
    let weightedRms = null;  // Weighted RMS (optimizer health metric)
    let snapshotTimestamp = null;  // When data was fetched
    let modelTimestamp = null;  // When model was run
    let topOutcomes = [];  // Top outcome maps from sampler (combined)
    let topSenateOutcomes = [];  // Senate-only outcome maps
    let topHouseOutcomes = [];  // House-only outcome maps
    let selectedMap = null;  // Currently selected outcome map (index)
    let marginals = {};  // Cached marginals for independent prob calculation
    let currentTab = 'senate';  // Current active tab
    let senateRaces = [];  // Senate races only
    let houseRaces = [];  // House races only

    // Tab switching
    function switchTab(tabName) {
        currentTab = tabName;
        // Update button states
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabName) btn.classList.add('active');
        });
        // Update content visibility
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + '-tab').classList.add('active');
        // Update display
        if (samples.length > 0) {
            updateCongressMatrix();
            updateHouseControl();
            renderTopMaps();  // Re-render with chamber-specific data
        }
    }

    // Initialize tab handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // State abbreviation to full name
    const stateNames = {
        'AL': 'Alabama', 'AK': 'Alaska', 'AR': 'Arkansas', 'AZ': 'Arizona',
        'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
        'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
        'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
        'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
        'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
        'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
        'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
        'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
        'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
        'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
        'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
        'WI': 'Wisconsin', 'WY': 'Wyoming'
    };

    // Hex grid layout (approximate US shape)
    const hexLayout = [
        [null, null, null, null, null, null, null, null, null, null, 'ME', null],
        [null, null, null, null, null, null, 'WI', null, null, 'VT', 'NH', null],
        ['WA', 'MT', 'ND', 'MN', null, null, 'MI', null, 'NY', 'MA', null, null],
        ['OR', 'ID', 'SD', 'IA', 'IL', 'IN', 'OH', 'PA', 'NJ', 'CT', 'RI', null],
        ['NV', 'WY', 'NE', 'MO', 'KY', 'WV', 'VA', 'MD', 'DE', null, null, null],
        ['CA', 'UT', 'CO', 'KS', 'AR', 'TN', 'NC', 'SC', null, null, null, null],
        ['AZ', 'NM', 'OK', 'LA', 'MS', 'AL', 'GA', null, 'FL', null, null, null],
        [null, null, 'TX', null, null, null, null, null, null, null, 'AK', 'HI'],
    ];

    function getStateCode(race) {
        return race.replace('_Senate', '').replace('_Special', '');
    }

    function getStateName(race) {
        const code = getStateCode(race);
        const special = race.includes('Special') ? ' (Special)' : '';
        return (stateNames[code] || code) + special;
    }

    function getRaceForState(stateCode) {
        // Check for special first, then regular
        const special = races.find(r => r === stateCode + '_Senate_Special');
        if (special) return special;
        return races.find(r => r === stateCode + '_Senate');
    }

    function getColor(dProb, iProb = 0) {
        // If Independent is leading, use gold
        if (iProb > dProb && iProb > (1 - dProb - iProb)) {
            if (iProb > 0.7) return '#d97706';  // amber-600
            if (iProb > 0.5) return '#f59e0b';  // amber-500
            return '#fbbf24';  // amber-400
        }
        // Blue (D) to Red (R) gradient
        if (dProb > 0.9) return '#1d4ed8';
        if (dProb > 0.7) return '#3b82f6';
        if (dProb > 0.55) return '#60a5fa';
        if (dProb > 0.45) return '#a78bfa';
        if (dProb > 0.3) return '#f87171';
        if (dProb > 0.1) return '#ef4444';
        return '#b91c1c';
    }

    // Compute autocorrelation at lag k for a numeric sequence
    function autocorrelation(values, lag) {
        const n = values.length;
        if (lag >= n) return 0;
        const mean = values.reduce((a, b) => a + b, 0) / n;
        const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
        if (variance === 0) return 0;

        let cov = 0;
        for (let i = 0; i < n - lag; i++) {
            cov += (values[i] - mean) * (values[i + lag] - mean);
        }
        return cov / ((n - lag) * variance);
    }

    // Compute ESS for a single chain's values using Geyer's initial positive sequence
    function computeChainESS(values) {
        const n = values.length;
        if (n < 4) return n;  // Too few samples, return raw count

        const mean = values.reduce((a, b) => a + b, 0) / n;
        const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
        if (variance < 1e-10) return n;  // Constant series

        // Geyer's initial positive sequence: sum consecutive pairs until negative
        let tau = 1;
        const maxLag = Math.min(100, Math.floor(n / 4));
        for (let k = 1; k < maxLag - 1; k += 2) {
            const rho1 = autocorrelation(values, k);
            const rho2 = autocorrelation(values, k + 1);
            const pairSum = rho1 + rho2;
            if (pairSum < 0) break;  // Stop at first negative pair sum
            tau += 2 * pairSum;
        }

        return Math.max(1, n / tau);
    }

    // Estimate ESS with per-chain awareness
    // Uses House seat count as the binding constraint (lowest ESS metric)
    function estimateESS(filteredSamples, filteredChainIds) {
        if (filteredSamples.length === 0) {
            return { n: 0, ess: 0, nChains: 0 };
        }

        // Compute House seat count for each sample (binding constraint)
        const houseSeats = filteredSamples.map(s => {
            return houseRaces.filter(r => s[r] === 'D').length;
        });

        // If no chain_ids, compute ESS on the full sequence (legacy behavior)
        if (!filteredChainIds || filteredChainIds.length === 0) {
            const ess = computeChainESS(houseSeats);
            return { n: filteredSamples.length, ess: Math.round(ess), nChains: 1 };
        }

        // Group samples by chain, preserving order within each chain
        const chainSamples = {};
        for (let i = 0; i < filteredSamples.length; i++) {
            const cid = filteredChainIds[i];
            if (!chainSamples[cid]) chainSamples[cid] = [];
            chainSamples[cid].push(houseSeats[i]);
        }

        // Compute ESS per chain and sum (chains are independent)
        let totalESS = 0;
        let nChains = 0;
        for (const cid of Object.keys(chainSamples)) {
            const values = chainSamples[cid];
            const chainESS = computeChainESS(values);
            totalESS += chainESS;
            nChains++;
        }

        return {
            n: filteredSamples.length,
            ess: Math.round(totalESS),
            nChains: nChains
        };
    }

    // Compute confidence interval for a proportion
    function binomialCI(p, n, z = 1.96) {
        // Wilson score interval (better for edge cases)
        const denominator = 1 + z * z / n;
        const center = (p + z * z / (2 * n)) / denominator;
        const halfWidth = z * Math.sqrt((p * (1 - p) + z * z / (4 * n)) / n) / denominator;
        return {
            low: Math.max(0, center - halfWidth),
            high: Math.min(1, center + halfWidth),
            moe: halfWidth
        };
    }

    async function loadData() {
        // Load samples (use ?web parameter for downsampled version)
        const useWeb = new URLSearchParams(window.location.search).has('web');
        const samplesFile = useWeb ? 'samples_web.json' : 'samples.json';
        const cacheBust = '?v=' + Date.now();
        if (useWeb) console.log('Using downsampled samples_web.json for performance');
        const samplesResp = await fetch('data/' + samplesFile + cacheBust);
        const samplesData = await samplesResp.json();
        samples = samplesData.samples;
        races = samplesData.races;
        chainIds = samplesData.chain_ids || [];  // For per-chain ESS computation
        console.log('Loaded', samples.length, 'samples with', new Set(chainIds).size, 'chains');

        // Separate races by chamber
        senateRaces = races.filter(r => r.includes('Senate'));
        houseRaces = races.filter(r => r.includes('House'));
        console.log('Senate races:', senateRaces.length, 'House races:', houseRaces.length);

        // Load summary (includes markets metadata and max error)
        const summaryResp = await fetch('data/summary.json' + cacheBust);
        const summaryData = await summaryResp.json();
        markets = summaryData.markets || [];
        // Prefer real_max (excludes synthetic priors) over max_error
        maxError = summaryData.metadata?.real_max || summaryData.metadata?.max_error || null;
        rmsError = summaryData.metadata?.rms_error || null;
        weightedRms = summaryData.metadata?.weighted_rms || null;
        snapshotTimestamp = summaryData.metadata?.snapshot_timestamp || null;
        modelTimestamp = summaryData.metadata?.generated_at || null;
        topOutcomes = summaryData.top_outcomes || [];
        topSenateOutcomes = summaryData.top_senate_outcomes || [];
        topHouseOutcomes = summaryData.top_house_outcomes || [];
        marginals = summaryData.marginals || {};
        console.log('Top outcomes loaded:', topOutcomes.length, 'Senate:', topSenateOutcomes.length, 'House:', topHouseOutcomes.length);

        // Estimate ESS from full sample with per-chain awareness
        essEstimate = estimateESS(samples, chainIds);
        console.log('ESS estimate:', essEstimate);
        console.log('Markets loaded:', markets.length, markets.map(m => m.name));
        console.log('Max error:', maxError);
        console.log('Snapshot timestamp:', snapshotTimestamp);

        document.getElementById('sample-count').textContent =
            `Source: ${samples.length.toLocaleString()} samples (${essEstimate.nChains} chains), ESS ≈ ${essEstimate.ess.toLocaleString()}`;
        render();

        // Update House and Congress tabs
        updateHouseControl();
        updateCongressMatrix();
    }

    function getFilteredSamples() {
        const filteredSamples = [];
        const filteredChainIds = [];
        for (let i = 0; i < samples.length; i++) {
            const s = samples[i];
            // Filter by race locks
            let pass = true;
            for (const [race, outcome] of Object.entries(locks)) {
                if (s[race] !== outcome) { pass = false; break; }
            }
            if (!pass) continue;
            // Filter by seat count lock (Senate only - histogram is Senate-only)
            if (seatLock !== null) {
                const senateRWins = senateRaces.filter(r => s[r] === 'R').length;
                const totalSenateR = 31 + senateRWins;
                if (totalSenateR !== seatLock) continue;
            }
            filteredSamples.push(s);
            if (chainIds.length > 0) filteredChainIds.push(chainIds[i]);
        }
        return { samples: filteredSamples, chainIds: filteredChainIds };
    }

    function computeStats(filteredSamples) {
        if (filteredSamples.length === 0) {
            return { marginals: {}, dControl: 0, rControl: 0, dHouseControl: 0, rHouseControl: 0, expectedR: 0 };
        }

        // Compute marginals for ALL races (both chambers)
        const marginals = {};
        for (const race of races) {
            const outcomes = {};
            for (const s of filteredSamples) {
                const outcome = s[race];
                outcomes[outcome] = (outcomes[outcome] || 0) + 1;
            }
            marginals[race] = {};
            for (const [outcome, count] of Object.entries(outcomes)) {
                marginals[race][outcome] = count / filteredSamples.length;
            }
            if (!marginals[race].D) marginals[race].D = 0;
            if (!marginals[race].R) marginals[race].R = 0;
        }

        // Compute Senate control (using senateRaces only)
        let dSenateControlCount = 0;
        let dHouseControlCount = 0;
        let totalSenateRWins = 0;
        for (const s of filteredSamples) {
            const senateRWins = senateRaces.filter(r => s[r] === 'R').length;
            totalSenateRWins += senateRWins;
            const senateDWins = senateRaces.filter(r => s[r] === 'D').length;
            // D needs 51 total. Has 34 baseline. Needs 17 D wins from 35 races.
            if (34 + senateDWins >= 51) dSenateControlCount++;

            // House control: D needs 218 seats (no baseline, all 435 modeled)
            const houseDWins = houseRaces.filter(r => s[r] === 'D').length;
            if (houseDWins >= 218) dHouseControlCount++;
        }

        return {
            marginals,
            dControl: dSenateControlCount / filteredSamples.length,
            rControl: 1 - dSenateControlCount / filteredSamples.length,
            dHouseControl: dHouseControlCount / filteredSamples.length,
            rHouseControl: 1 - dHouseControlCount / filteredSamples.length,
            expectedR: totalSenateRWins / filteredSamples.length  // Senate R wins only
        };
    }

    function computeCorrelations(race, marginals, filteredSamples) {
        if (!race || filteredSamples.length < 100) return [];

        const baseProb = marginals[race]?.D || 0.5;
        const correlations = [];

        for (const other of races) {
            if (other === race) continue;

            // P(other=D | race=D)
            const bothD = filteredSamples.filter(s => s[race] === 'D' && s[other] === 'D').length;
            const raceD = filteredSamples.filter(s => s[race] === 'D').length;
            const conditionalProb = raceD > 0 ? bothD / raceD : 0;
            const baseOtherProb = marginals[other]?.D || 0.5;
            const lift = conditionalProb - baseOtherProb;

            correlations.push({ race: other, lift, conditionalProb });
        }

        correlations.sort((a, b) => Math.abs(b.lift) - Math.abs(a.lift));
        return correlations.slice(0, 5);
    }

    // Compute independent probability for a specific outcome map
    // Returns P(map) = ∏ P(state=outcome) assuming independence
    function computeIndependentProb(outcomeMap) {
        if (!marginals || Object.keys(marginals).length === 0) return null;

        let logProb = 0;
        for (const [race, outcome] of Object.entries(outcomeMap)) {
            const raceProbs = marginals[race];
            if (!raceProbs) continue;
            const p = raceProbs[outcome] || 0.001;  // Small floor to avoid log(0)
            logProb += Math.log(p);
        }
        return Math.exp(logProb);
    }

    function selectMap(index) {
        selectedMap = (selectedMap === index) ? null : index;
        render();
    }

    // Compute Senate/House breakdown from an outcome map
    function getOutcomeBreakdown(outcomes) {
        if (!outcomes) return { senateR: 0, senateD: 0, houseR: 0, houseD: 0 };
        let senateR = 31, senateD = 34;  // Baseline non-contested seats
        let houseR = 0, houseD = 0;
        for (const [race, result] of Object.entries(outcomes)) {
            if (race.includes('Senate')) {
                if (result === 'R') senateR++;
                else if (result === 'D') senateD++;
            } else if (race.includes('House')) {
                if (result === 'R') houseR++;
                else if (result === 'D') houseD++;
            }
        }
        return { senateR, senateD, houseR, houseD };
    }

    function renderTopMaps() {
        const container = document.getElementById('top-maps');

        // Select data source based on current tab
        let outcomes;
        if (currentTab === 'senate' && topSenateOutcomes.length > 0) {
            outcomes = topSenateOutcomes;
        } else if (currentTab === 'house' && topHouseOutcomes.length > 0) {
            outcomes = topHouseOutcomes;
        } else {
            outcomes = topOutcomes;  // Fallback to combined (Congress tab or missing data)
        }

        if (outcomes.length === 0) {
            container.innerHTML = '<div style="color: #666; text-align: center;">No outcome data</div>';
            return;
        }

        // Determine what chambers are in the data
        const hasSenate = outcomes[0]?.outcomes && Object.keys(outcomes[0].outcomes).some(r => r.includes('Senate'));
        const hasHouse = outcomes[0]?.outcomes && Object.keys(outcomes[0].outcomes).some(r => r.includes('House'));

        // Find max probability for bar scaling
        const maxProb = Math.max(...outcomes.slice(0, 15).map(o => o.model_prob));

        let html = '';
        const displayCount = Math.min(15, outcomes.length);

        for (let i = 0; i < displayCount; i++) {
            const outcome = outcomes[i];
            const barWidth = (outcome.model_prob / maxProb) * 100;
            const isSelected = selectedMap === i;

            // Compute Senate/House breakdown
            const breakdown = getOutcomeBreakdown(outcome.outcomes);
            const senateControl = breakdown.senateR >= 51 ? 'R' : 'D';
            const houseControl = breakdown.houseR >= 218 ? 'R' : 'D';

            // Determine control class based on what chambers are present
            let controlClass;
            if (hasSenate && hasHouse) {
                controlClass = senateControl === 'R' && houseControl === 'R' ? 'r-control' :
                               senateControl === 'D' && houseControl === 'D' ? 'd-control' : 'split-control';
            } else if (hasSenate) {
                controlClass = senateControl === 'R' ? 'r-control' : 'd-control';
            } else {
                controlClass = houseControl === 'R' ? 'r-control' : 'd-control';
            }

            // Build seats display based on what's in the data
            let seatsDisplay = '';
            if (hasSenate && hasHouse) {
                seatsDisplay = `S: ${breakdown.senateR}-${breakdown.senateD}<br>H: ${breakdown.houseR}-${breakdown.houseD}`;
            } else if (hasSenate) {
                seatsDisplay = `${breakdown.senateR}R-${breakdown.senateD}D`;
            } else if (hasHouse) {
                seatsDisplay = `${breakdown.houseR}R-${breakdown.houseD}D`;
            }

            html += `
                <div class="map-item ${isSelected ? 'selected' : ''}" onclick="selectMap(${i})">
                    <span class="rank">#${outcome.rank}</span>
                    <div class="bar-container">
                        <div class="bar ${controlClass}" style="width: ${barWidth}%">
                            ${outcome.model_prob.toFixed(1)}%
                        </div>
                    </div>
                    <span class="seats" style="width: 65px; font-size: 9px; line-height: 1.2;">
                        ${seatsDisplay}
                    </span>
                </div>
            `;
        }

        // Detail panel for selected map
        if (selectedMap !== null && outcomes[selectedMap]) {
            const outcome = outcomes[selectedMap];

            // Compute independent probability directly from marginals
            const indepProb = outcome.outcomes ? computeIndependentProb(outcome.outcomes) : null;
            const indepPct = indepProb ? (indepProb * 100) : outcome.indep_prob;
            const detailBreakdown = getOutcomeBreakdown(outcome.outcomes);

            // Get sample count (may be from new field or computed from model_prob)
            const sampleCount = outcome.sample_count || Math.round(outcome.model_prob * samples.length / 100);

            html += `
                <div class="map-detail">
                    <div class="stat-row">
                        <span class="label">Model probability</span>
                        <span class="value">${outcome.model_prob.toFixed(2)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">Independent probability</span>
                        <span class="value">${indepPct.toFixed(2)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">Matching samples</span>
                        <span class="value">${sampleCount.toLocaleString()} (${outcome.model_prob.toFixed(1)}%)</span>
                    </div>
                    ${hasSenate ? `
                    <div class="stat-row">
                        <span class="label">Senate</span>
                        <span class="value" style="color: ${detailBreakdown.senateR >= 51 ? '#ef4444' : '#3b82f6'}">
                            ${detailBreakdown.senateR}R-${detailBreakdown.senateD}D
                        </span>
                    </div>
                    ` : ''}
                    ${hasHouse ? `
                    <div class="stat-row">
                        <span class="label">House</span>
                        <span class="value" style="color: ${detailBreakdown.houseR >= 218 ? '#ef4444' : '#3b82f6'}">
                            ${detailBreakdown.houseR}R-${detailBreakdown.houseD}D
                        </span>
                    </div>
                    ` : ''}
                    ${outcome.upsets && outcome.upsets.length > 0 ? `
                        <div class="upsets">
                            <span class="label">Upsets vs baseline:</span>
                            <div style="margin-top: 4px;">
                                ${outcome.upsets.map(u => `<span class="upset-tag">${u}</span>`).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="upsets">
                            <span class="label" style="color: #22c55e;">No upsets (baseline scenario)</span>
                        </div>
                    `}
                </div>
                <button class="clear-map-btn" onclick="selectMap(null)">Clear selection</button>
            `;
        }

        container.innerHTML = html;
    }

    function render() {
        const filterResult = getFilteredSamples();
        const filtered = filterResult.samples;
        const filteredChainIds = filterResult.chainIds;
        const stats = computeStats(filtered);

        // Update control bar
        document.getElementById('d-control').textContent =
            filtered.length > 0 ? (stats.dControl * 100).toFixed(0) + '%' : '--';
        document.getElementById('r-control').textContent =
            filtered.length > 0 ? (stats.rControl * 100).toFixed(0) + '%' : '--';
        const projectedR = filtered.length > 0 ? Math.round(31 + stats.expectedR) : null;
        document.getElementById('expected-seats').textContent =
            projectedR !== null ? `${projectedR}R-${100-projectedR}D` : '--';

        // Compute ESS on filtered samples with per-chain awareness
        essEstimate = estimateESS(filtered, filteredChainIds);
        const currentESS = essEstimate.ess;

        document.getElementById('stat-total').textContent = samples.length.toLocaleString();
        const filteredEl = document.getElementById('stat-filtered');
        filteredEl.textContent = filtered.length.toLocaleString();
        filteredEl.className = 'value' + (filtered.length < 100 ? ' error' : filtered.length < 500 ? ' warning' : '');

        const essEl = document.getElementById('stat-ess');
        essEl.textContent = currentESS.toLocaleString();
        essEl.className = 'value' + (currentESS < 100 ? ' error' : currentESS < 400 ? ' warning' : '');

        // Display max constraint error
        const maxErrEl = document.getElementById('stat-max-error');
        if (maxError !== null) {
            maxErrEl.textContent = (maxError * 100).toFixed(1) + '%';
            maxErrEl.className = 'value' + (maxError > 0.1 ? ' error' : maxError > 0.05 ? ' warning' : '');
        } else {
            maxErrEl.textContent = '--';
        }

        // Display RMS constraint error
        const rmsErrEl = document.getElementById('stat-rms-error');
        if (rmsError !== null) {
            rmsErrEl.textContent = (rmsError * 100).toFixed(1) + '%';
            rmsErrEl.className = 'value' + (rmsError > 0.05 ? ' error' : rmsError > 0.025 ? ' warning' : '');
        } else {
            rmsErrEl.textContent = '--';
        }

        // Display timestamps
        const dataTs = document.getElementById('stat-data-timestamp');
        if (snapshotTimestamp) {
            const ts = new Date(snapshotTimestamp);
            dataTs.textContent = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        } else {
            dataTs.textContent = '--';
        }

        const modelTs = document.getElementById('stat-model-timestamp');
        if (modelTimestamp) {
            const ts = new Date(modelTimestamp);
            modelTs.textContent = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        } else {
            modelTs.textContent = '--';
        }

        // Compute confidence interval for D control
        if (filtered.length > 0) {
            const ci = binomialCI(stats.dControl, currentESS);
            const moeEl = document.getElementById('stat-moe');
            moeEl.textContent = '±' + (ci.moe * 100).toFixed(1) + '%';
            moeEl.className = 'value' + (ci.moe > 0.1 ? ' warning' : '');

            // Update CI bar
            document.getElementById('ci-range').style.left = (ci.low * 100) + '%';
            document.getElementById('ci-range').style.width = ((ci.high - ci.low) * 100) + '%';
            document.getElementById('ci-point').style.left = (stats.dControl * 100) + '%';
            document.getElementById('ci-text').textContent =
                `${(ci.low * 100).toFixed(1)}% – ${(stats.dControl * 100).toFixed(1)}% – ${(ci.high * 100).toFixed(1)}%`;
        } else {
            document.getElementById('stat-moe').textContent = '--';
            document.getElementById('ci-text').textContent = '--';
        }

        // Render hex map
        const hexGrid = document.getElementById('hex-grid');
        hexGrid.innerHTML = '';

        // Get selected outcome map if any
        const selectedOutcome = (selectedMap !== null && topOutcomes[selectedMap])
            ? topOutcomes[selectedMap].outcomes
            : null;

        for (const row of hexLayout) {
            for (const stateCode of row) {
                const cell = document.createElement('div');
                cell.className = 'hex-cell';

                if (!stateCode) {
                    cell.classList.add('empty');
                } else {
                    const race = getRaceForState(stateCode);
                    if (race) {
                        // If showing a specific outcome map, use solid colors
                        if (selectedOutcome && selectedOutcome[race]) {
                            const outcome = selectedOutcome[race];
                            if (outcome === 'D') {
                                cell.style.background = '#3b82f6';
                                cell.innerHTML = `${stateCode}<span class="prob">D</span>`;
                            } else if (outcome === 'R') {
                                cell.style.background = '#ef4444';
                                cell.innerHTML = `${stateCode}<span class="prob">R</span>`;
                            } else {
                                cell.style.background = '#fbbf24';
                                cell.innerHTML = `${stateCode}<span class="prob">I</span>`;
                            }
                            cell.title = `${getStateName(race)}: ${outcome}`;
                        } else {
                            // Show marginal probabilities
                            const m = stats.marginals[race] || { D: 0.5, R: 0.5 };
                            const iProb = (m.I_Osborn || 0) + (m.I_Other || 0);
                            const dPct = (m.D * 100).toFixed(0);
                            cell.style.background = getColor(m.D, iProb);
                            // Show leading outcome's probability
                            const leadingPct = iProb > m.D && iProb > m.R ?
                                (iProb * 100).toFixed(0) + 'I' :
                                m.D > m.R ? dPct + 'D' : ((m.R * 100).toFixed(0) + 'R');
                            cell.innerHTML = `${stateCode}<span class="prob">${leadingPct.slice(0,-1)}</span>`;
                            cell.title = getStateName(race);
                        }

                        if (locks[race]) cell.classList.add('locked');
                        if (selected === race) cell.classList.add('selected');

                        cell.addEventListener('click', () => selectRace(race));
                        cell.addEventListener('dblclick', () => toggleLock(race));
                    } else {
                        cell.style.background = '#333';
                        cell.textContent = stateCode;
                        cell.style.opacity = 0.3;
                    }
                }
                hexGrid.appendChild(cell);
            }
        }

        // Render snake charts for each chamber
        renderSnakeChart(senateRaces, 'snake-chart', stats, selectedOutcome);
        renderSnakeChart(houseRaces, 'house-snake-chart', stats, selectedOutcome);

        // Render histograms for each chamber
        renderHistogram(filtered, senateRaces, 'histogram', 31, 51);  // Senate: 31 baseline R, 51 for control
        renderHistogram(filtered, houseRaces, 'house-histogram', 0, 218);  // House: 0 baseline, 218 for control

        // Render top outcome maps
        renderTopMaps();

        // Update sidebar
        updateSidebar(stats, filtered);
    }

    // Helper to get display name for a race
    function getRaceDisplayName(race) {
        if (race.includes('House')) {
            // Format: AZ_01_House -> AZ-01
            const parts = race.replace('_House', '').split('_');
            if (parts[1] === 'AL') return parts[0] + '-AL';  // At-large
            return parts[0] + '-' + parts[1];
        }
        return getStateCode(race);  // Senate uses state code
    }

    function renderSnakeChart(raceList, elementId, stats, selectedOutcome = null) {
        const chart = document.getElementById(elementId);
        if (!chart || raceList.length === 0) return;

        // Sort by P(R): lowest P(R) on left (D-leaning), highest P(R) on right (R-leaning)
        const sortedRaces = [...raceList].sort((a, b) => {
            const aR = locks[a] === 'D' ? 0.0 : locks[a] === 'R' ? 1.0 :
                       locks[a]?.startsWith('I_') ? (stats.marginals[a]?.R || 0) : (stats.marginals[a]?.R || 0.5);
            const bR = locks[b] === 'D' ? 0.0 : locks[b] === 'R' ? 1.0 :
                       locks[b]?.startsWith('I_') ? (stats.marginals[b]?.R || 0) : (stats.marginals[b]?.R || 0.5);
            return aR - bR;
        });

        chart.innerHTML = '';

        for (const race of sortedRaces) {
            const m = stats.marginals[race] || { D: 0.5, R: 0.5 };
            const iProb = (m.I_Osborn || 0) + (m.I_Other || 0);
            const item = document.createElement('div');
            item.className = 'snake-item';
            if (locks[race]) item.classList.add('locked');
            if (selected === race) item.classList.add('selected');

            // If showing a specific outcome map, use solid colors
            if (selectedOutcome && selectedOutcome[race]) {
                const outcome = selectedOutcome[race];
                if (outcome === 'D') {
                    item.style.background = '#3b82f6';
                    item.innerHTML = `<span class="state">${getRaceDisplayName(race)}</span><span class="pct">D</span>`;
                } else if (outcome === 'R') {
                    item.style.background = '#ef4444';
                    item.innerHTML = `<span class="state">${getRaceDisplayName(race)}</span><span class="pct">R</span>`;
                } else {
                    item.style.background = '#fbbf24';
                    item.innerHTML = `<span class="state">${getRaceDisplayName(race)}</span><span class="pct">I</span>`;
                }
                item.title = `${race}: ${outcome}`;
            } else {
                item.style.background = getColor(m.D, iProb);
                const leadPct = iProb > m.D && iProb > m.R ?
                    (iProb * 100).toFixed(0) + '% I' :
                    m.D > m.R ? (m.D * 100).toFixed(0) + '% D' : (m.R * 100).toFixed(0) + '% R';
                item.innerHTML = `
                    <span class="state">${getRaceDisplayName(race)}</span>
                    <span class="pct">${leadPct}</span>
                `;
                item.title = race;
            }
            item.addEventListener('click', () => selectRace(race));
            item.addEventListener('dblclick', () => toggleLock(race));
            chart.appendChild(item);
        }
    }

    function renderHistogram(filteredSamples, raceList, elementId, baselineR, controlThreshold) {
        const histogram = document.getElementById(elementId);
        if (!histogram || raceList.length === 0) return;

        if (filteredSamples.length === 0) {
            histogram.innerHTML = '<div style="color: #666; text-align: center; width: 100%;">No matching samples</div>';
            return;
        }

        const totalSeats = raceList.length + baselineR + (controlThreshold * 2 - raceList.length - baselineR * 2);
        // For Senate: 100 total, for House: 435 total
        const chamberTotal = elementId === 'histogram' ? 100 : 435;

        // Compute seat counts for each sample
        const seatValues = [];
        const seatCounts = {};
        for (const s of filteredSamples) {
            const rWins = raceList.filter(r => s[r] === 'R').length;
            const totalR = baselineR + rWins;
            seatValues.push(totalR);
            seatCounts[totalR] = (seatCounts[totalR] || 0) + 1;
        }

        // Find 1st and 99th percentile for range, ensuring we include the control threshold
        seatValues.sort((a, b) => a - b);
        const p01Idx = Math.floor(seatValues.length * 0.01);
        const p99Idx = Math.min(seatValues.length - 1, Math.floor(seatValues.length * 0.99));
        let minSeat = Math.min(seatValues[p01Idx], controlThreshold - 1);
        let maxSeat = Math.max(seatValues[p99Idx], controlThreshold);
        // Ensure at least a small range
        if (minSeat >= maxSeat) {
            minSeat = Math.max(0, maxSeat - 5);
            maxSeat = minSeat + 10;
        }
        const maxCount = Math.max(...Object.values(seatCounts));

        // Build bars
        histogram.innerHTML = '';
        for (let seat = minSeat; seat <= maxSeat; seat++) {
            const count = seatCounts[seat] || 0;
            const pct = count / filteredSamples.length;
            const height = maxCount > 0 ? (count / maxCount) * 100 : 0;

            const bar = document.createElement('div');
            // For Senate: < 50 is D control, for House: < 218 is D control
            const isDControl = seat < controlThreshold;
            bar.className = 'hist-bar ' + (isDControl ? 'dem' : 'rep');
            if (seatLock === seat && elementId === 'histogram') bar.classList.add('locked');
            bar.style.height = height + '%';
            bar.title = `${seat}R / ${chamberTotal-seat}D: ${(pct * 100).toFixed(1)}% (${count.toLocaleString()} samples)`;
            if (elementId === 'histogram') {
                bar.addEventListener('click', () => toggleSeatLock(seat));
            }
            histogram.appendChild(bar);
        }

        // Update labels to match actual range
        const container = histogram.closest('.histogram-container');
        if (container) {
            const labels = container.querySelector('.histogram-labels');
            if (labels) {
                const mid = elementId === 'histogram' ? '50-50' : '218 (Control)';
                labels.innerHTML = `
                    <span>${chamberTotal - minSeat}D</span>
                    <span>${mid}</span>
                    <span>${maxSeat}R</span>
                `;
            }
        }
    }

    function selectRace(race) {
        selected = (selected === race) ? null : race;
        render();
        // Auto-scroll to selected race panel on mobile
        if (selected && window.innerWidth <= 768) {
            setTimeout(() => {
                document.getElementById('selected-race').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 50);
        }
    }

    function toggleSeatLock(seats) {
        seatLock = (seatLock === seats) ? null : seats;
        render();
    }

    function toggleLock(race) {
        const filtered = getFilteredSamples().samples;
        const stats = computeStats(filtered);
        const m = stats.marginals[race] || { D: 0.5 };
        // Use global marginals to check for independent option
        const globalM = marginals[race] || {};
        const hasIndependent = globalM.I_Osborn !== undefined;

        if (locks[race]) {
            // Cycle through outcomes
            if (hasIndependent) {
                // D → R → I_Osborn → unlock
                if (locks[race] === 'D') locks[race] = 'R';
                else if (locks[race] === 'R') locks[race] = 'I_Osborn';
                else delete locks[race];
            } else {
                // D → R → unlock
                if (locks[race] === 'D') locks[race] = 'R';
                else delete locks[race];
            }
        } else {
            // Lock to leading outcome
            const iProb = (m.I_Osborn || 0) + (m.I_Other || 0);
            if (iProb > m.D && iProb > m.R) {
                locks[race] = 'I_Osborn';
            } else {
                locks[race] = m.D > m.R ? 'D' : 'R';
            }
        }
        render();
    }

    // Update House control display
    function updateHouseControl() {
        if (houseRaces.length === 0) return;

        const filtered = getFilteredSamples().samples;
        let dControl = 0;
        let totalDSeats = 0;

        filtered.forEach(s => {
            const dWins = houseRaces.filter(r => s[r] === 'D').length;
            totalDSeats += dWins;
            if (dWins >= 218) dControl++;
        });

        const dControlPct = (dControl / filtered.length * 100).toFixed(1);
        const rControlPct = (100 - dControlPct).toFixed(1);
        const avgDSeats = (totalDSeats / filtered.length).toFixed(0);
        const avgRSeats = 435 - avgDSeats;

        document.getElementById('house-d-control').textContent = dControlPct + '%';
        document.getElementById('house-r-control').textContent = rControlPct + '%';
        document.getElementById('house-expected-seats').textContent = `${avgDSeats}D - ${avgRSeats}R`;
    }

    // Update Congress control matrix
    function updateCongressMatrix() {
        if (senateRaces.length === 0 || houseRaces.length === 0) return;

        const filtered = getFilteredSamples().samples;
        let counts = { dd: 0, dr: 0, rd: 0, rr: 0 };

        filtered.forEach(s => {
            const senateDWins = senateRaces.filter(r => s[r] === 'D').length;
            const houseDWins = houseRaces.filter(r => s[r] === 'D').length;
            const senateD = 34 + senateDWins >= 51;  // 34 baseline D + wins >= 51 for majority
            const houseD = houseDWins >= 218;

            if (senateD && houseD) counts.dd++;
            else if (senateD && !houseD) counts.dr++;
            else if (!senateD && houseD) counts.rd++;
            else counts.rr++;
        });

        const n = filtered.length;
        document.getElementById('matrix-dd').textContent = (counts.dd / n * 100).toFixed(1) + '%';
        document.getElementById('matrix-dr').textContent = (counts.dr / n * 100).toFixed(1) + '%';
        document.getElementById('matrix-rd').textContent = (counts.rd / n * 100).toFixed(1) + '%';
        document.getElementById('matrix-rr').textContent = (counts.rr / n * 100).toFixed(1) + '%';

        // Color the cells
        const cells = [
            { id: 'matrix-dd', val: counts.dd / n, color: '#3b82f6' },
            { id: 'matrix-dr', val: counts.dr / n, color: '#8b5cf6' },
            { id: 'matrix-rd', val: counts.rd / n, color: '#8b5cf6' },
            { id: 'matrix-rr', val: counts.rr / n, color: '#ef4444' }
        ];
        cells.forEach(c => {
            const el = document.getElementById(c.id);
            const alpha = 0.3 + c.val * 0.7;  // Scale opacity by probability
            el.style.background = c.color + Math.round(alpha * 255).toString(16).padStart(2, '0');
        });

        // Trifectas (assuming R president for 2026 midterms)
        document.getElementById('d-trifecta').textContent = '0%';  // Can't have D trifecta with R president
        document.getElementById('r-trifecta').textContent = (counts.rr / n * 100).toFixed(1) + '%';
    }

    function updateSidebar(stats, filtered) {
        // Selected race panel
        const selectedRace = document.getElementById('selected-race');
        if (selected) {
            const m = stats.marginals[selected] || { D: 0.5, R: 0.5 };
            const isLocked = locks[selected];
            // Use global marginals to determine if race has independent option
            // (filtered marginals won't have I_Osborn if locked to D/R)
            const globalM = marginals[selected] || {};
            const hasIndependent = globalM.I_Osborn !== undefined || globalM.I_Other !== undefined;
            const iOsborn = m.I_Osborn || 0;
            const iOther = m.I_Other || 0;

            let probDisplay = `
                <div class="prob-item dem">
                    <div class="party">Democrat</div>
                    <div class="pct">${(m.D * 100).toFixed(1)}%</div>
                </div>
                <div class="prob-item rep">
                    <div class="party">Republican</div>
                    <div class="pct">${(m.R * 100).toFixed(1)}%</div>
                </div>`;

            if (hasIndependent) {
                probDisplay += `
                <div class="prob-item" style="color: #fbbf24;">
                    <div class="party">Osborn (I)</div>
                    <div class="pct">${(iOsborn * 100).toFixed(1)}%</div>
                </div>`;
                if (iOther > 0.001) {
                    probDisplay += `
                <div class="prob-item" style="color: #d97706;">
                    <div class="party">Other (I)</div>
                    <div class="pct">${(iOther * 100).toFixed(1)}%</div>
                </div>`;
                }
            }

            let lockButtons = `
                <button class="lock-d" onclick="lockRace('${selected}', 'D')">Lock D</button>
                <button class="lock-r" onclick="lockRace('${selected}', 'R')">Lock R</button>`;
            if (hasIndependent) {
                lockButtons += `
                <button style="background: #f59e0b; color: #000;" onclick="lockRace('${selected}', 'I_Osborn')">Lock Osborn</button>`;
            }
            if (isLocked) {
                lockButtons += `<button class="unlock" onclick="unlockRace('${selected}')">Unlock</button>`;
            }

            selectedRace.innerHTML = `
                <div class="state-name">${getStateName(selected)}</div>
                <div class="race-type">${selected.includes('Special') ? 'Special Election' : 'Class 2 Senate Race'}</div>
                <div class="prob-display" style="flex-wrap: wrap;">
                    ${probDisplay}
                </div>
                <div class="actions">
                    ${lockButtons}
                </div>
            `;

            // Show correlations
            const correlations = computeCorrelations(selected, stats.marginals, filtered);
            const corrPanel = document.getElementById('correlations-panel');
            const corrList = document.getElementById('corr-list');
            if (correlations.length > 0) {
                corrPanel.style.display = 'block';
                corrList.innerHTML = correlations.map(c => `
                    <div class="corr-item">
                        <span>${getStateCode(c.race)}</span>
                        <span class="val ${c.lift > 0 ? 'pos' : 'neg'}">${c.lift > 0 ? '+' : ''}${(c.lift * 100).toFixed(1)}%</span>
                    </div>
                `).join('');
            } else {
                corrPanel.style.display = 'none';
            }
        } else {
            selectedRace.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">Click a state to see details</div>`;
            document.getElementById('correlations-panel').style.display = 'none';
        }

        // Locked panel
        const lockedPanel = document.getElementById('locked-panel');
        const lockedSummary = document.getElementById('locked-summary');
        const lockedRaces = Object.entries(locks);

        const hasLocks = lockedRaces.length > 0 || seatLock !== null;
        if (hasLocks) {
            lockedPanel.style.display = 'block';
            document.getElementById('reset-btn').style.display = 'block';
            let html = '';
            if (seatLock !== null) {
                html += `<div class="locked-item">
                    <span>Seat count</span>
                    <span class="outcome" style="color: #fbbf24;">${seatLock}R / ${100-seatLock}D</span>
                </div>`;
            }
            html += lockedRaces.map(([race, outcome]) => {
                const displayOutcome = outcome === 'I_Osborn' ? 'Osborn (I)' :
                                       outcome === 'I_Other' ? 'Other (I)' : outcome;
                return `
                <div class="locked-item">
                    <span>${getStateCode(race)}</span>
                    <span class="outcome ${outcome}">${displayOutcome}</span>
                </div>`;
            }).join('');
            html += `<div style="color: #666; font-size: 11px; margin-top: 8px;">${filtered.length} matching samples</div>`;
            lockedSummary.innerHTML = html;
        } else {
            lockedPanel.style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none';
        }

        // Markets panel
        const marketsList = document.getElementById('markets-list');
        const marketsHeader = document.querySelector('#markets-panel h2');
        console.log('Rendering markets panel, selected:', selected, 'markets:', markets.length);

        if (markets.length > 0) {
            // Sort markets: relevant to selected state first, then by volume
            let sortedMarkets = [...markets];
            if (selected) {
                sortedMarkets.sort((a, b) => {
                    const aRelevant = a.related_races.includes(selected);
                    const bRelevant = b.related_races.includes(selected);
                    if (aRelevant && !bRelevant) return -1;
                    if (!aRelevant && bRelevant) return 1;
                    return (b.volume || 0) - (a.volume || 0);
                });
                marketsHeader.textContent = `Markets (${getStateCode(selected)})`;
            } else {
                sortedMarkets.sort((a, b) => (b.volume || 0) - (a.volume || 0));
                marketsHeader.textContent = 'All Markets';
            }

            marketsList.innerHTML = sortedMarkets.map(m => {
                const isRelevant = selected && m.related_races.includes(selected);
                const volStr = m.volume >= 1000 ? `${(m.volume/1000).toFixed(1)}k` : Math.round(m.volume);

                // Get price comparison for this market
                let priceCompare = '';
                if (m.prices && Object.keys(m.prices).length > 0) {
                    if (m.type === 'multi_race' && selected) {
                        // For omnibus, show selected state's price vs model
                        // Use exact full-name matching (substring matching fails: "ME" matches "New Mexico")
                        const stateCode = getStateCode(selected);
                        const fullName = stateNames[stateCode];
                        const isSpecial = selected.includes('Special');
                        const stateName = Object.keys(m.prices).find(k => {
                            if (k === fullName) return true;
                            // Handle special elections: "Ohio (Special)" or "Florida (Special)"
                            if (isSpecial && k === fullName + ' (Special)') return true;
                            return false;
                        });
                        if (stateName && m.prices[stateName] !== undefined) {
                            const mktPrice = m.prices[stateName];
                            const modelProb = stats.marginals[selected]?.R || 0;
                            const diff = modelProb - mktPrice;
                            const diffClass = Math.abs(diff) > 0.05 ? 'warning' : '';
                            priceCompare = `<div class="price-compare ${diffClass}">
                                ${stateName}: Mkt ${(mktPrice*100).toFixed(0)}% vs Model ${(modelProb*100).toFixed(0)}%
                                <span class="diff">(${diff > 0 ? '+' : ''}${(diff*100).toFixed(1)}%)</span>
                            </div>`;
                        }
                    } else if (m.type === 'control') {
                        // R Control market - determine if Senate or House from name
                        const isHouse = m.name.toLowerCase().includes('house');
                        const mktPrice = m.prices['YES'] || 0;
                        const modelProb = isHouse ? stats.rHouseControl : stats.rControl;
                        const diff = modelProb - mktPrice;
                        const diffClass = Math.abs(diff) > 0.05 ? 'warning' : '';
                        const chamberLabel = isHouse ? 'House' : 'Senate';
                        priceCompare = `<div class="price-compare ${diffClass}">
                            R ${chamberLabel}: Mkt ${(mktPrice*100).toFixed(0)}% vs Model ${(modelProb*100).toFixed(0)}%
                            <span class="diff">(${diff > 0 ? '+' : ''}${(diff*100).toFixed(1)}%)</span>
                        </div>`;
                    } else if (m.type === 'joint_control') {
                        // Balance of Power - show D Senate probability
                        const dSenate = (m.prices['Democratic House and Senate'] || 0) +
                                       (m.prices['Republican House, Democratic Senate'] || 0);
                        const modelDControl = stats.dControl || 0;
                        const diff = modelDControl - dSenate;
                        const diffClass = Math.abs(diff) > 0.05 ? 'warning' : '';
                        priceCompare = `<div class="price-compare ${diffClass}">
                            D Senate: Mkt ${(dSenate*100).toFixed(0)}% vs Model ${(modelDControl*100).toFixed(0)}%
                            <span class="diff">(${diff > 0 ? '+' : ''}${(diff*100).toFixed(1)}%)</span>
                        </div>`;
                    } else if (m.type === 'union_constraint' && m.condition) {
                        // Union constraint - compute from filtered samples for conditional probs
                        const mktPrice = m.prices['YES'] || 0;
                        // Parse condition: "(RACE == OUTCOME) OR (RACE == OUTCOME) OR ..."
                        const conditions = m.condition.split(' OR ').map(part => {
                            const match = part.match(/(\w+)\s*==\s*(\w+)/);
                            return match ? { race: match[1], outcome: match[2] } : null;
                        }).filter(c => c);

                        // Compute from filtered samples
                        let matchCount = 0;
                        for (const s of filtered) {
                            if (conditions.some(c => s[c.race] === c.outcome)) {
                                matchCount++;
                            }
                        }
                        const modelProb = filtered.length > 0 ? matchCount / filtered.length : 0;

                        const diff = modelProb - mktPrice;
                        const diffClass = Math.abs(diff) > 0.05 ? 'warning' : '';
                        priceCompare = `<div class="price-compare ${diffClass}">
                            Mkt ${(mktPrice*100).toFixed(0)}% vs Model ${(modelProb*100).toFixed(0)}%
                            <span class="diff">(${diff > 0 ? '+' : ''}${(diff*100).toFixed(1)}%)</span>
                        </div>`;
                    } else if (m.type === 'single_race' && m.race) {
                        // Single race market (e.g., Nebraska 4-way)
                        // Show model vs market for each outcome
                        const modelM = stats.marginals[m.race] || {};
                        const priceLines = [];
                        // Map answer text to outcome codes
                        const outcomeMap = {
                            'Republican': 'R',
                            'Democratic': 'D',
                            'Independent (Dan Osborn)': 'I_Osborn',
                            'Independent (Other)': 'I_Other'
                        };
                        for (const [text, mktPrice] of Object.entries(m.prices)) {
                            const outcome = outcomeMap[text];
                            if (outcome && modelM[outcome] !== undefined) {
                                const modelProb = modelM[outcome];
                                const diff = modelProb - mktPrice;
                                if (Math.abs(diff) > 0.02) {  // Only show if >2% diff
                                    const diffClass = Math.abs(diff) > 0.05 ? 'warning' : '';
                                    priceLines.push(`<span class="${diffClass}">${text.substring(0,3)}: ${(mktPrice*100).toFixed(0)}→${(modelProb*100).toFixed(0)}%</span>`);
                                }
                            }
                        }
                        if (priceLines.length > 0) {
                            priceCompare = `<div class="price-compare">${priceLines.join(' · ')}</div>`;
                        }
                    }
                }

                return `
                    <div class="market-item ${isRelevant ? 'relevant' : ''}">
                        <a href="${m.url}?r=RXZhbkRhbmllbA" target="_blank">${m.name}</a>
                        ${priceCompare}
                        <div class="market-meta">
                            <span class="vol">M$${volStr} vol</span> ·
                            <span class="bettors">${m.uniqueBettorCount} traders</span>
                            ${m.related_races.length > 0 && m.related_races.length < 10 ? ` · ${m.related_races.length} races` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            marketsList.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">No markets loaded</div>';
        }
    }

    function lockRace(race, outcome) {
        locks[race] = outcome;
        render();
    }

    function unlockRace(race) {
        delete locks[race];
        render();
    }

    document.getElementById('reset-btn').addEventListener('click', () => {
        locks = {};
        seatLock = null;
        render();
    });

    loadData();
    </script>
</body>
</html>
