<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Senate Forecast</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a; color: #eee;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 320px;
            min-height: 100vh;
        }

        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        h1 { text-align: center; margin-bottom: 5px; font-size: 24px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }

        /* Control Bar */
        .control-bar {
            display: flex; justify-content: center; gap: 40px;
            margin-bottom: 20px; padding: 15px;
            background: #1a1a2e; border-radius: 10px;
        }
        .control-stat { text-align: center; }
        .control-stat .label { font-size: 12px; color: #666; text-transform: uppercase; }
        .control-stat .value { font-size: 32px; font-weight: bold; }
        .control-stat.dem .value { color: #3b82f6; }
        .control-stat.rep .value { color: #ef4444; }

        /* Hex Map */
        .hex-map {
            display: flex; justify-content: center;
            margin-bottom: 20px;
        }
        .hex-grid {
            display: grid;
            grid-template-columns: repeat(12, 44px);
            gap: 2px;
        }
        .hex-cell {
            width: 44px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 2px solid transparent;
            position: relative;
        }
        .hex-cell:hover { transform: scale(1.1); z-index: 10; }
        .hex-cell.selected { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .hex-cell.locked { border-color: #fbbf24; }
        .hex-cell.empty { visibility: hidden; }
        .hex-cell .prob {
            position: absolute; bottom: 2px; right: 3px;
            font-size: 8px; opacity: 0.8;
        }

        /* Snake Chart */
        .snake-section { margin-top: 20px; }
        .snake-section h2 { font-size: 16px; margin-bottom: 10px; color: #888; }
        .snake-chart {
            display: flex; flex-wrap: wrap; gap: 4px;
            padding: 10px;
            background: #1a1a2e; border-radius: 8px;
        }
        .snake-item {
            width: 50px; height: 36px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .snake-item:hover { transform: scale(1.1); z-index: 10; }
        .snake-item.selected { border-color: #fff; }
        .snake-item.locked { border-color: #fbbf24; }
        .snake-item .state { font-weight: bold; }
        .snake-item .pct { font-size: 9px; opacity: 0.8; }

        /* Sidebar */
        .sidebar {
            background: #1a1a2e;
            border-left: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar h2 { font-size: 14px; color: #888; margin-bottom: 15px; text-transform: uppercase; }

        .selected-race {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .selected-race .state-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .selected-race .race-type { color: #666; font-size: 12px; margin-bottom: 10px; }
        .selected-race .prob-display {
            display: flex; gap: 20px; margin: 15px 0;
        }
        .selected-race .prob-item { text-align: center; }
        .selected-race .prob-item .party { font-size: 12px; color: #888; }
        .selected-race .prob-item .pct { font-size: 24px; font-weight: bold; }
        .selected-race .prob-item.dem .pct { color: #3b82f6; }
        .selected-race .prob-item.rep .pct { color: #ef4444; }

        .selected-race .actions { margin-top: 15px; }
        .selected-race .actions button {
            padding: 8px 16px; margin-right: 8px;
            border: none; border-radius: 4px;
            cursor: pointer; font-size: 12px;
        }
        .selected-race .actions .lock-d { background: #3b82f6; color: #fff; }
        .selected-race .actions .lock-r { background: #ef4444; color: #fff; }
        .selected-race .actions .unlock { background: #374151; color: #fff; }

        .locked-summary {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .locked-summary .locked-item {
            display: flex; justify-content: space-between;
            padding: 5px 0; border-bottom: 1px solid #333;
            font-size: 13px;
        }
        .locked-summary .locked-item:last-child { border-bottom: none; }
        .locked-summary .locked-item .outcome { font-weight: bold; }
        .locked-summary .locked-item .outcome.D { color: #3b82f6; }
        .locked-summary .locked-item .outcome.R { color: #ef4444; }

        .correlations {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
        }
        .correlations h3 { font-size: 12px; color: #888; margin-bottom: 10px; }
        .corr-item {
            display: flex; justify-content: space-between;
            padding: 4px 0; font-size: 12px;
        }
        .corr-item .val { font-weight: bold; }
        .corr-item .val.pos { color: #22c55e; }
        .corr-item .val.neg { color: #ef4444; }

        .reset-all {
            width: 100%; padding: 10px;
            background: #374151; color: #fff;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 20px;
        }
        .reset-all:hover { background: #4b5563; }

        .sample-count {
            text-align: center; color: #555; font-size: 11px;
            margin-top: 15px;
        }

        /* Sample Statistics Panel */
        .sample-stats {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .sample-stats h3 { font-size: 12px; color: #888; margin-bottom: 10px; }
        .stat-row {
            display: flex; justify-content: space-between;
            padding: 3px 0; font-size: 12px;
        }
        .stat-row .label { color: #888; }
        .stat-row .value { font-weight: bold; }
        .stat-row .value.warning { color: #fbbf24; }
        .stat-row .value.error { color: #ef4444; }

        .ci-display {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #333;
        }
        .ci-display .label { font-size: 11px; color: #666; margin-bottom: 5px; }
        .ci-bar {
            height: 20px; background: #1a1a2e; border-radius: 4px;
            position: relative; overflow: hidden;
        }
        .ci-bar .range {
            position: absolute; height: 100%;
            background: linear-gradient(90deg, #3b82f6, #a78bfa, #ef4444);
            opacity: 0.6;
        }
        .ci-bar .point {
            position: absolute; height: 100%; width: 3px;
            background: #fff; top: 0;
        }
        .ci-bar .ticks {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: space-between;
            padding: 0 2px; font-size: 8px; color: #666;
            align-items: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1>2026 Senate Forecast</h1>
            <p class="subtitle">Click states to select, double-click to lock outcomes</p>

            <div class="control-bar">
                <div class="control-stat dem">
                    <div class="label">D Control</div>
                    <div class="value" id="d-control">--</div>
                </div>
                <div class="control-stat">
                    <div class="label">Expected</div>
                    <div class="value" id="expected-seats">--</div>
                </div>
                <div class="control-stat rep">
                    <div class="label">R Control</div>
                    <div class="value" id="r-control">--</div>
                </div>
            </div>

            <div class="hex-map">
                <div class="hex-grid" id="hex-grid"></div>
            </div>

            <div class="snake-section">
                <h2>Races by Competitiveness (Tipping Point Analysis)</h2>
                <div class="snake-chart" id="snake-chart"></div>
            </div>
        </div>

        <div class="sidebar">
            <h2>Sample Statistics</h2>
            <div class="sample-stats" id="sample-stats">
                <div class="stat-row">
                    <span class="label">Total samples</span>
                    <span class="value" id="stat-total">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Filtered samples</span>
                    <span class="value" id="stat-filtered">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Effective sample size</span>
                    <span class="value" id="stat-ess">--</span>
                </div>
                <div class="stat-row">
                    <span class="label">Margin of error (95%)</span>
                    <span class="value" id="stat-moe">--</span>
                </div>
                <div class="ci-display">
                    <div class="label">D Control probability (95% CI)</div>
                    <div class="ci-bar" id="ci-bar">
                        <div class="range" id="ci-range"></div>
                        <div class="point" id="ci-point"></div>
                        <div class="ticks"><span>0%</span><span>50%</span><span>100%</span></div>
                    </div>
                    <div style="text-align: center; font-size: 11px; margin-top: 5px; color: #888;" id="ci-text">--</div>
                </div>
            </div>

            <div id="selected-panel">
                <h2>Selected Race</h2>
                <div class="selected-race" id="selected-race">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        Click a state to see details
                    </div>
                </div>
            </div>

            <div id="locked-panel" style="display: none;">
                <h2>Locked Outcomes</h2>
                <div class="locked-summary" id="locked-summary"></div>
            </div>

            <div id="correlations-panel" style="display: none;">
                <h2>Correlated Races</h2>
                <div class="correlations" id="correlations">
                    <h3>If this race flips, most affected:</h3>
                    <div id="corr-list"></div>
                </div>
            </div>

            <button class="reset-all" id="reset-btn" style="display: none;">Reset All Locks</button>
            <div class="sample-count" id="sample-count"></div>
        </div>
    </div>

    <script>
    let samples = [];
    let races = [];
    let locks = {};
    let selected = null;
    let essEstimate = null;  // Cached ESS from full sample

    // State abbreviation to full name
    const stateNames = {
        'AL': 'Alabama', 'AK': 'Alaska', 'AR': 'Arkansas', 'AZ': 'Arizona',
        'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
        'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
        'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
        'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
        'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
        'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
        'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
        'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
        'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
        'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
        'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
        'WI': 'Wisconsin', 'WY': 'Wyoming'
    };

    // Hex grid layout (approximate US shape)
    const hexLayout = [
        [null, null, null, null, null, null, null, null, null, null, 'ME', null],
        [null, null, null, null, null, null, 'WI', null, null, 'VT', 'NH', null],
        ['WA', 'MT', 'ND', 'MN', null, null, 'MI', null, 'NY', 'MA', null, null],
        ['OR', 'ID', 'SD', 'IA', 'IL', 'IN', 'OH', 'PA', 'NJ', 'CT', 'RI', null],
        ['NV', 'WY', 'NE', 'MO', 'KY', 'WV', 'VA', 'MD', 'DE', null, null, null],
        ['CA', 'UT', 'CO', 'KS', 'AR', 'TN', 'NC', 'SC', null, null, null, null],
        ['AZ', 'NM', 'OK', 'LA', 'MS', 'AL', 'GA', null, 'FL', null, null, null],
        [null, null, 'TX', null, null, null, null, null, null, null, 'AK', 'HI'],
    ];

    function getStateCode(race) {
        return race.replace('_Senate', '').replace('_Special', '');
    }

    function getStateName(race) {
        const code = getStateCode(race);
        const special = race.includes('Special') ? ' (Special)' : '';
        return (stateNames[code] || code) + special;
    }

    function getRaceForState(stateCode) {
        // Check for special first, then regular
        const special = races.find(r => r === stateCode + '_Senate_Special');
        if (special) return special;
        return races.find(r => r === stateCode + '_Senate');
    }

    function getColor(dProb) {
        // Blue (D) to Red (R) gradient
        if (dProb > 0.9) return '#1d4ed8';
        if (dProb > 0.7) return '#3b82f6';
        if (dProb > 0.55) return '#60a5fa';
        if (dProb > 0.45) return '#a78bfa';
        if (dProb > 0.3) return '#f87171';
        if (dProb > 0.1) return '#ef4444';
        return '#b91c1c';
    }

    // Compute autocorrelation at lag k for a binary sequence
    function autocorrelation(values, lag) {
        const n = values.length;
        if (lag >= n) return 0;
        const mean = values.reduce((a, b) => a + b, 0) / n;
        const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
        if (variance === 0) return 0;

        let cov = 0;
        for (let i = 0; i < n - lag; i++) {
            cov += (values[i] - mean) * (values[i + lag] - mean);
        }
        return cov / ((n - lag) * variance);
    }

    // Estimate effective sample size from D Control indicator
    function estimateESS(samples) {
        // Compute D control indicator (binary)
        const dControlIndicator = samples.map(s => {
            const rWins = races.filter(r => s[r] === 'R').length;
            return (35 - rWins >= 17) ? 1 : 0;
        });

        // Estimate integrated autocorrelation time using initial sequence estimator
        // τ = 1 + 2 * sum(ρ(k)) for k where ρ(k) > 0
        let tau = 1;
        const maxLag = Math.min(100, Math.floor(samples.length / 4));
        for (let k = 1; k < maxLag; k++) {
            const rho = autocorrelation(dControlIndicator, k);
            if (rho < 0.05) break;  // Truncate when autocorrelation is negligible
            tau += 2 * rho;
        }

        return {
            n: samples.length,
            tau: tau,
            ess: Math.round(samples.length / tau)
        };
    }

    // Compute confidence interval for a proportion
    function binomialCI(p, n, z = 1.96) {
        // Wilson score interval (better for edge cases)
        const denominator = 1 + z * z / n;
        const center = (p + z * z / (2 * n)) / denominator;
        const halfWidth = z * Math.sqrt((p * (1 - p) + z * z / (4 * n)) / n) / denominator;
        return {
            low: Math.max(0, center - halfWidth),
            high: Math.min(1, center + halfWidth),
            moe: halfWidth
        };
    }

    async function loadData() {
        const resp = await fetch('data/samples.json');
        const data = await resp.json();
        samples = data.samples;
        races = data.races;

        // Estimate ESS from full sample (cache it)
        essEstimate = estimateESS(samples);
        console.log('ESS estimate:', essEstimate);

        document.getElementById('sample-count').textContent =
            `Source: ${samples.length.toLocaleString()} samples, ESS ≈ ${essEstimate.ess.toLocaleString()}`;
        render();
    }

    function getFilteredSamples() {
        return samples.filter(s => {
            for (const [race, outcome] of Object.entries(locks)) {
                if (s[race] !== outcome) return false;
            }
            return true;
        });
    }

    function computeStats(filteredSamples) {
        if (filteredSamples.length === 0) {
            return { marginals: {}, dControl: 0, rControl: 0, expectedR: 0 };
        }

        const marginals = {};
        for (const race of races) {
            const rCount = filteredSamples.filter(s => s[race] === 'R').length;
            marginals[race] = {
                R: rCount / filteredSamples.length,
                D: 1 - rCount / filteredSamples.length
            };
        }

        let dControlCount = 0;
        let totalRWins = 0;
        for (const s of filteredSamples) {
            const rWins = races.filter(r => s[r] === 'R').length;
            totalRWins += rWins;
            if (35 - rWins >= 17) dControlCount++;
        }

        return {
            marginals,
            dControl: dControlCount / filteredSamples.length,
            rControl: 1 - dControlCount / filteredSamples.length,
            expectedR: totalRWins / filteredSamples.length
        };
    }

    function computeCorrelations(race, marginals, filteredSamples) {
        if (!race || filteredSamples.length < 100) return [];

        const baseProb = marginals[race]?.D || 0.5;
        const correlations = [];

        for (const other of races) {
            if (other === race) continue;

            // P(other=D | race=D)
            const bothD = filteredSamples.filter(s => s[race] === 'D' && s[other] === 'D').length;
            const raceD = filteredSamples.filter(s => s[race] === 'D').length;
            const conditionalProb = raceD > 0 ? bothD / raceD : 0;
            const baseOtherProb = marginals[other]?.D || 0.5;
            const lift = conditionalProb - baseOtherProb;

            correlations.push({ race: other, lift, conditionalProb });
        }

        correlations.sort((a, b) => Math.abs(b.lift) - Math.abs(a.lift));
        return correlations.slice(0, 5);
    }

    function render() {
        const filtered = getFilteredSamples();
        const stats = computeStats(filtered);

        // Update control bar
        document.getElementById('d-control').textContent =
            filtered.length > 0 ? (stats.dControl * 100).toFixed(0) + '%' : '--';
        document.getElementById('r-control').textContent =
            filtered.length > 0 ? (stats.rControl * 100).toFixed(0) + '%' : '--';
        document.getElementById('expected-seats').textContent =
            filtered.length > 0 ? (31 + stats.expectedR).toFixed(0) + 'R' : '--';

        // Update sample statistics
        const nLocks = Object.keys(locks).length;
        // When filtering, ESS scales proportionally to sample fraction
        const effectiveFiltered = nLocks > 0 ? filtered.length : samples.length;
        const essFraction = effectiveFiltered / samples.length;
        const currentESS = Math.round((essEstimate?.ess || filtered.length) * essFraction);

        document.getElementById('stat-total').textContent = samples.length.toLocaleString();
        const filteredEl = document.getElementById('stat-filtered');
        filteredEl.textContent = filtered.length.toLocaleString();
        filteredEl.className = 'value' + (filtered.length < 100 ? ' error' : filtered.length < 500 ? ' warning' : '');

        document.getElementById('stat-ess').textContent = currentESS.toLocaleString();

        // Compute confidence interval for D control
        if (filtered.length > 0) {
            const ci = binomialCI(stats.dControl, currentESS);
            const moeEl = document.getElementById('stat-moe');
            moeEl.textContent = '±' + (ci.moe * 100).toFixed(1) + '%';
            moeEl.className = 'value' + (ci.moe > 0.1 ? ' warning' : '');

            // Update CI bar
            document.getElementById('ci-range').style.left = (ci.low * 100) + '%';
            document.getElementById('ci-range').style.width = ((ci.high - ci.low) * 100) + '%';
            document.getElementById('ci-point').style.left = (stats.dControl * 100) + '%';
            document.getElementById('ci-text').textContent =
                `${(ci.low * 100).toFixed(1)}% – ${(stats.dControl * 100).toFixed(1)}% – ${(ci.high * 100).toFixed(1)}%`;
        } else {
            document.getElementById('stat-moe').textContent = '--';
            document.getElementById('ci-text').textContent = '--';
        }

        // Render hex map
        const hexGrid = document.getElementById('hex-grid');
        hexGrid.innerHTML = '';

        for (const row of hexLayout) {
            for (const stateCode of row) {
                const cell = document.createElement('div');
                cell.className = 'hex-cell';

                if (!stateCode) {
                    cell.classList.add('empty');
                } else {
                    const race = getRaceForState(stateCode);
                    if (race) {
                        const m = stats.marginals[race] || { D: 0.5, R: 0.5 };
                        const dPct = (m.D * 100).toFixed(0);
                        cell.style.background = getColor(m.D);
                        cell.innerHTML = `${stateCode}<span class="prob">${dPct}</span>`;
                        cell.title = getStateName(race);

                        if (locks[race]) cell.classList.add('locked');
                        if (selected === race) cell.classList.add('selected');

                        cell.addEventListener('click', () => selectRace(race));
                        cell.addEventListener('dblclick', () => toggleLock(race));
                    } else {
                        cell.style.background = '#333';
                        cell.textContent = stateCode;
                        cell.style.opacity = 0.3;
                    }
                }
                hexGrid.appendChild(cell);
            }
        }

        // Render snake chart
        const sortedRaces = [...races].sort((a, b) => {
            const aD = stats.marginals[a]?.D || 0.5;
            const bD = stats.marginals[b]?.D || 0.5;
            return bD - aD;  // D-leaning first
        });

        const snakeChart = document.getElementById('snake-chart');
        snakeChart.innerHTML = '';

        for (const race of sortedRaces) {
            const m = stats.marginals[race] || { D: 0.5, R: 0.5 };
            const item = document.createElement('div');
            item.className = 'snake-item';
            if (locks[race]) item.classList.add('locked');
            if (selected === race) item.classList.add('selected');

            item.style.background = getColor(m.D);
            item.innerHTML = `
                <span class="state">${getStateCode(race)}</span>
                <span class="pct">${(m.D * 100).toFixed(0)}%</span>
            `;
            item.title = getStateName(race);
            item.addEventListener('click', () => selectRace(race));
            item.addEventListener('dblclick', () => toggleLock(race));
            snakeChart.appendChild(item);
        }

        // Update sidebar
        updateSidebar(stats, filtered);
    }

    function selectRace(race) {
        selected = (selected === race) ? null : race;
        render();
    }

    function toggleLock(race) {
        if (locks[race]) {
            if (locks[race] === 'D') locks[race] = 'R';
            else delete locks[race];
        } else {
            const filtered = getFilteredSamples();
            const stats = computeStats(filtered);
            const m = stats.marginals[race] || { D: 0.5 };
            locks[race] = m.D > 0.5 ? 'D' : 'R';
        }
        render();
    }

    function updateSidebar(stats, filtered) {
        // Selected race panel
        const selectedRace = document.getElementById('selected-race');
        if (selected) {
            const m = stats.marginals[selected] || { D: 0.5, R: 0.5 };
            const isLocked = locks[selected];
            selectedRace.innerHTML = `
                <div class="state-name">${getStateName(selected)}</div>
                <div class="race-type">${selected.includes('Special') ? 'Special Election' : 'Class 2 Senate Race'}</div>
                <div class="prob-display">
                    <div class="prob-item dem">
                        <div class="party">Democrat</div>
                        <div class="pct">${(m.D * 100).toFixed(1)}%</div>
                    </div>
                    <div class="prob-item rep">
                        <div class="party">Republican</div>
                        <div class="pct">${(m.R * 100).toFixed(1)}%</div>
                    </div>
                </div>
                <div class="actions">
                    <button class="lock-d" onclick="lockRace('${selected}', 'D')">Lock D</button>
                    <button class="lock-r" onclick="lockRace('${selected}', 'R')">Lock R</button>
                    ${isLocked ? `<button class="unlock" onclick="unlockRace('${selected}')">Unlock</button>` : ''}
                </div>
            `;

            // Show correlations
            const correlations = computeCorrelations(selected, stats.marginals, filtered);
            const corrPanel = document.getElementById('correlations-panel');
            const corrList = document.getElementById('corr-list');
            if (correlations.length > 0) {
                corrPanel.style.display = 'block';
                corrList.innerHTML = correlations.map(c => `
                    <div class="corr-item">
                        <span>${getStateCode(c.race)}</span>
                        <span class="val ${c.lift > 0 ? 'pos' : 'neg'}">${c.lift > 0 ? '+' : ''}${(c.lift * 100).toFixed(1)}%</span>
                    </div>
                `).join('');
            } else {
                corrPanel.style.display = 'none';
            }
        } else {
            selectedRace.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">Click a state to see details</div>`;
            document.getElementById('correlations-panel').style.display = 'none';
        }

        // Locked panel
        const lockedPanel = document.getElementById('locked-panel');
        const lockedSummary = document.getElementById('locked-summary');
        const lockedRaces = Object.entries(locks);

        if (lockedRaces.length > 0) {
            lockedPanel.style.display = 'block';
            document.getElementById('reset-btn').style.display = 'block';
            lockedSummary.innerHTML = lockedRaces.map(([race, outcome]) => `
                <div class="locked-item">
                    <span>${getStateCode(race)}</span>
                    <span class="outcome ${outcome}">${outcome}</span>
                </div>
            `).join('') + `<div style="color: #666; font-size: 11px; margin-top: 8px;">${filtered.length} matching samples</div>`;
        } else {
            lockedPanel.style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none';
        }
    }

    function lockRace(race, outcome) {
        locks[race] = outcome;
        render();
    }

    function unlockRace(race) {
        delete locks[race];
        render();
    }

    document.getElementById('reset-btn').addEventListener('click', () => {
        locks = {};
        render();
    });

    loadData();
    </script>
</body>
</html>
